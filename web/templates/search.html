{% extends "base.html" %}

{% block title %}Search - Chat with Your Documents{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <div class="px-4 py-6 sm:px-0">
        <!-- Search Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Search Documents</h1>
            <p class="mt-1 text-sm text-gray-600">Search through your document collections using semantic search</p>
        </div>

        <!-- Search Form -->
        <div class="bg-white shadow rounded-lg p-6 mb-6">
            <form id="search-form" class="space-y-6">
                <!-- Search Query -->
                <div>
                    <label for="search-query" class="block text-sm font-medium text-gray-700">Search Query</label>
                    <div class="mt-1 relative">
                        <input type="text" id="search-query" name="query" required
                               class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm px-4 py-3"
                               placeholder="Enter your search query...">
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                            <i data-lucide="search" class="h-5 w-5 text-gray-400"></i>
                        </div>
                    </div>
                </div>

                <!-- Search Options -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Collection Selection -->
                    <div>
                        <label for="collection-select" class="block text-sm font-medium text-gray-700">Collection</label>
                        <select id="collection-select" name="collection_id"
                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="">All Collections</option>
                        </select>
                    </div>

                    <!-- Search Type -->
                    <div>
                        <label for="search-type" class="block text-sm font-medium text-gray-700">Search Type</label>
                        <select id="search-type" name="search_type"
                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="vector">Vector Search</option>
                            <option value="hybrid">Hybrid Search</option>
                        </select>
                    </div>

                    <!-- Results Count -->
                    <div>
                        <label for="results-count" class="block text-sm font-medium text-gray-700">Results</label>
                        <select id="results-count" name="top_k"
                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="5">5 results</option>
                            <option value="10" selected>10 results</option>
                            <option value="20">20 results</option>
                            <option value="50">50 results</option>
                        </select>
                    </div>
                </div>

                <!-- Advanced Options (Collapsible) -->
                <div class="border-t pt-6">
                    <button type="button" id="advanced-toggle" class="flex items-center text-sm font-medium text-gray-700 hover:text-gray-900 focus:outline-none">
                        <i data-lucide="chevron-right" class="h-4 w-4 mr-1 transition-transform" id="chevron-icon"></i>
                        Advanced Options
                    </button>

                    <div id="advanced-options" class="hidden mt-4 space-y-4">
                        <!-- Similarity Threshold -->
                        <div>
                            <label for="similarity-threshold" class="block text-sm font-medium text-gray-700">
                                Similarity Threshold: <span id="threshold-value">0.5</span>
                            </label>
                            <input type="range" id="similarity-threshold" name="threshold"
                                   min="0" max="1" step="0.1" value="0.5"
                                   class="mt-1 block w-full">
                        </div>

                        <!-- Additional Filters -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Document Types</label>
                            <div class="flex flex-wrap gap-2">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" name="file_types" value="pdf" checked
                                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-700">PDF</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" name="file_types" value="doc" checked
                                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-700">DOC</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" name="file_types" value="txt" checked
                                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    <span class="ml-2 text-sm text-gray-700">TXT</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search Button -->
                <div class="flex justify-end">
                    <button type="submit" id="search-btn"
                            class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="search" class="h-5 w-5 mr-2"></i>
                        Search Documents
                    </button>
                </div>
            </form>
        </div>

        <!-- Search Statistics -->
        <div id="search-stats" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <div class="flex items-center">
                <i data-lucide="info" class="h-5 w-5 text-blue-600 mr-2"></i>
                <span id="stats-text" class="text-sm text-blue-800"></span>
            </div>
        </div>

        <!-- Search Results -->
        <div id="search-results" class="space-y-4">
            <!-- Results will be populated here -->
        </div>

        <!-- No Results Message -->
        <div id="no-results" class="hidden text-center py-12">
            <i data-lucide="search-x" class="h-12 w-12 text-gray-400 mx-auto mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No results found</h3>
            <p class="text-gray-600">Try adjusting your search query or filters</p>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="text-center py-12">
            <i data-lucide="file-search" class="h-12 w-12 text-gray-400 mx-auto mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Search your documents</h3>
            <p class="text-gray-600">Enter a search query above to find relevant content in your document collections</p>
        </div>
    </div>
</div>

<!-- Search Result Template -->
<template id="search-result-template">
    <div class="bg-white shadow rounded-lg p-6 hover:shadow-md transition-shadow">
        <div class="flex items-start justify-between">
            <div class="flex-1">
                <div class="flex items-center space-x-2 mb-2">
                    <i data-lucide="file-text" class="h-4 w-4 text-gray-500"></i>
                    <span class="text-sm font-medium text-gray-900 result-document-name"></span>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 result-collection-name"></span>
                </div>
                <p class="text-gray-700 text-sm mb-3 result-content"></p>
                <div class="flex items-center space-x-4 text-xs text-gray-500">
                    <span class="flex items-center">
                        <i data-lucide="target" class="h-3 w-3 mr-1"></i>
                        <span class="result-similarity"></span>% match
                    </span>
                    <span class="flex items-center">
                        <i data-lucide="hash" class="h-3 w-3 mr-1"></i>
                        Chunk <span class="result-chunk-index"></span>
                    </span>
                </div>
            </div>
            <div class="ml-4 flex-shrink-0">
                <button class="text-gray-400 hover:text-gray-600 focus:outline-none view-context-btn"
                        data-document-id="">
                    <i data-lucide="external-link" class="h-4 w-4"></i>
                </button>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize search page
    initializeSearch();
});

async function initializeSearch() {
    // Load collections for dropdown
    await loadCollections();

    // Initialize event listeners
    initializeEventListeners();

    // Initialize advanced options toggle
    initializeAdvancedOptions();
}

async function loadCollections() {
    try {
        const collections = await utils.apiRequest('/collections/');
        const select = document.getElementById('collection-select');

        // Clear existing options except "All Collections"
        select.innerHTML = '<option value="">All Collections</option>';

        collections.forEach(collection => {
            const option = document.createElement('option');
            option.value = collection.id;
            option.textContent = collection.name;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Failed to load collections:', error);
        utils.showToast('Failed to load collections', 'error');
    }
}

function initializeEventListeners() {
    // Search form submission
    document.getElementById('search-form').addEventListener('submit', handleSearch);

    // Real-time threshold value update
    const thresholdSlider = document.getElementById('similarity-threshold');
    const thresholdValue = document.getElementById('threshold-value');

    thresholdSlider.addEventListener('input', function() {
        thresholdValue.textContent = this.value;
    });

    // Search on Enter key
    document.getElementById('search-query').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('search-form').dispatchEvent(new Event('submit'));
        }
    });
}

function initializeAdvancedOptions() {
    const toggleBtn = document.getElementById('advanced-toggle');
    const options = document.getElementById('advanced-options');
    const chevron = document.getElementById('chevron-icon');

    toggleBtn.addEventListener('click', function() {
        const isHidden = options.classList.contains('hidden');

        if (isHidden) {
            options.classList.remove('hidden');
            chevron.style.transform = 'rotate(90deg)';
        } else {
            options.classList.add('hidden');
            chevron.style.transform = 'rotate(0deg)';
        }
    });
}

async function handleSearch(event) {
    event.preventDefault();

    const formData = new FormData(event.target);
    const searchParams = {
        query_text: formData.get('query'),
        collection_id: formData.get('collection_id') || null,
        chat_history: [],
        config: {
            top_k: parseInt(formData.get('top_k')),
            use_hybrid: formData.get('search_type') === 'hybrid',
            use_intent_classification: true,
            query_transformation: {
                enabled: true,
                methods: ["multi_query"]
            },
            filters: {},
        }
    };

    // Add file type filters
    const fileTypes = formData.getAll('file_types');
    if (fileTypes.length > 0 && fileTypes.length < 3) {
        searchParams.config.filters.file_type = fileTypes;
    }

    // Add similarity threshold if specified
    const threshold = parseFloat(formData.get('threshold'));
    if (threshold > 0) {
        searchParams.config.filters.min_similarity = threshold;
    }

    try {
        const searchBtn = document.getElementById('search-btn');
        const originalText = searchBtn.innerHTML;

        // Update button state
        searchBtn.disabled = true;
        searchBtn.innerHTML = '<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div>Searching...';

        // Hide previous results and states
        document.getElementById('search-results').innerHTML = '';
        document.getElementById('no-results').classList.add('hidden');
        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('search-stats').classList.add('hidden');

        // Perform search
        const results = await utils.apiRequest('/search/', {
            method: 'POST',
            body: JSON.stringify(searchParams)
        });

        // Display results
        displaySearchResults(results, searchParams);

        // Restore button state
        searchBtn.disabled = false;
        searchBtn.innerHTML = originalText;

    } catch (error) {
        console.error('Search failed:', error);
        utils.showToast('Search failed: ' + error.message, 'error');

        // Restore button state
        const searchBtn = document.getElementById('search-btn');
        searchBtn.disabled = false;
        searchBtn.innerHTML = '<i data-lucide="search" class="h-5 w-5 mr-2"></i>Search Documents';
        lucide.createIcons();
    }
}

function displaySearchResults(results, searchParams) {
    const resultsContainer = document.getElementById('search-results');
    const noResultsDiv = document.getElementById('no-results');
    const emptyStateDiv = document.getElementById('empty-state');
    const statsDiv = document.getElementById('search-stats');
    const statsText = document.getElementById('stats-text');

    if (!results || results.length === 0) {
        noResultsDiv.classList.remove('hidden');
        return;
    }

    // Show search statistics
    const searchType = searchParams.use_hybrid ? 'hybrid' : 'vector';
    statsText.textContent = `Found ${results.length} results using ${searchType} search`;
    statsDiv.classList.remove('hidden');

    // Create result elements
    const template = document.getElementById('search-result-template');

    results.forEach((result, index) => {
        const resultElement = template.content.cloneNode(true);

        // Populate result data
        resultElement.querySelector('.result-document-name').textContent = result.document_name || 'Unknown Document';
        resultElement.querySelector('.result-collection-name').textContent = result.collection_name || 'Default';
        resultElement.querySelector('.result-content').textContent = result.content || 'No content available';
        resultElement.querySelector('.result-similarity').textContent = Math.round((result.similarity || 0) * 100);
        resultElement.querySelector('.result-chunk-index').textContent = result.chunk_index || index + 1;

        // Set up context view button
        const viewBtn = resultElement.querySelector('.view-context-btn');
        viewBtn.setAttribute('data-document-id', result.document_id || '');
        viewBtn.addEventListener('click', () => viewDocumentContext(result));

        resultsContainer.appendChild(resultElement);
    });

    // Reinitialize icons for new elements
    lucide.createIcons();
}

function viewDocumentContext(result) {
    // Create modal or detailed view for document context
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-4xl max-h-96 overflow-auto">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="text-lg font-medium text-gray-900">${result.document_name || 'Document Context'}</h3>
                    <p class="text-sm text-gray-600">Chunk ${result.chunk_index || 'N/A'} • ${Math.round((result.similarity || 0) * 100)}% match</p>
                </div>
                <button class="text-gray-400 hover:text-gray-600 close-modal">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            <div class="prose prose-sm max-w-none">
                <p class="text-gray-700 whitespace-pre-wrap">${result.content || 'No content available'}</p>
            </div>
        </div>
    `;

    // Add close functionality
    modal.querySelector('.close-modal').addEventListener('click', () => {
        document.body.removeChild(modal);
    });

    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            document.body.removeChild(modal);
        }
    });

    document.body.appendChild(modal);
    lucide.createIcons();
}
</script>
{% endblock %}
