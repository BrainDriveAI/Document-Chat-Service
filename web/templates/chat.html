{% extends "base.html" %}

{% block title %}Chat - Chat with Your Documents{% endblock %}

{% block content %}
<div class="flex h-screen bg-gray-50 overflow-hidden">
    <!-- Sidebar -->
    <div class="w-64 bg-white shadow-sm border-r flex flex-col h-full">
        <!-- Collection Info -->
        <div class="p-4 border-b flex-shrink-0">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-lg font-semibold text-gray-900">Chat Sessions</h2>
                <button id="new-chat-btn" class="p-1.5 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded">
                    <i data-lucide="plus" class="h-4 w-4"></i>
                </button>
            </div>
            <!-- Collection Selector -->
            <div class="mb-3">
                <label for="collection-selector"></label>
                <select id="collection-selector" class="w-full text-sm border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Select Collection...</option>
                </select>
            </div>
            <div id="collection-info" class="hidden">
                <div class="flex items-center">
                    <div id="current-collection-color" class="w-3 h-3 rounded-full mr-2"></div>
                    <span id="current-collection-name" class="text-sm font-medium text-gray-700"></span>
                </div>
            </div>
        </div>
        <!-- Chat Sessions List -->
        <div class="flex-1 overflow-y-auto custom-scrollbar min-h-0">
            <div id="chat-sessions-loading" class="p-4 text-center">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto"></div>
                <p class="text-sm text-gray-500 mt-2">Loading sessions...</p>
            </div>
            <div id="chat-sessions-empty" class="hidden p-4 text-center text-gray-500">
                <i data-lucide="message-circle" class="h-8 w-8 mx-auto mb-2"></i>
                <p class="text-sm">No chat sessions yet</p>
                <p class="text-xs">Select a collection to start chatting</p>
            </div>
            <div id="chat-sessions-list" class="hidden overflow-y-auto flex-1">
                <!-- Chat sessions will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="flex-1 flex flex-col h-full min-h-0">
        <!-- Chat Header -->
        <div class="bg-white border-b px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 id="chat-title" class="text-xl font-semibold text-gray-900">Select a collection to start chatting</h1>
                    <p id="chat-subtitle" class="text-sm text-gray-500 hidden">Ask questions about your documents</p>
                </div>
                <div class="flex space-x-2 hidden">
                    <button id="search-btn" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded" title="Search documents">
                        <i data-lucide="search" class="h-5 w-5"></i>
                    </button>
                    <button id="settings-btn" class="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded" title="Chat settings">
                        <i data-lucide="settings" class="h-5 w-5"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Messages Area -->
        <div class="flex-1 overflow-y-auto custom-scrollbar bg-gray-50 min-h-0">
            <div id="messages-container" class="max-w-4xl mx-auto p-4 h-full overflow-y-auto">
                <!-- Welcome Message -->
                <div id="welcome-message" class="text-center py-4 max-h-full overflow-y-auto">
                    <div class="bg-white rounded-xl shadow-lg p-6 max-w-2xl mx-auto border border-gray-100">
                        <!-- Header with animated icon -->
                        <div class="mb-6">
                            <div class="relative inline-block hidden">
                                <div class="absolute inset-0 bg-blue-100 rounded-full animate-pulse"></div>
                                <div class="relative bg-blue-600 rounded-full p-3">
                                    <img src="{{ url_for('static', path='brand_logo.svg') }}" alt="Brain Drive Logo" class="h-8 w-8">
                                </div>
                            </div>
                            <h1 class="text-2xl font-bold text-gray-900 mt-4 mb-2">Welcome to BrainDrive CWYD</h1>
                            <p class="text-gray-600 text-lg">Your intelligent document assistant</p>
                        </div>

                        <!-- Getting Started Steps -->
                        <div class="mb-8">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">Get Started in 3 Steps</h2>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-4 border border-blue-100">
                                    <div class="flex items-center justify-center w-8 h-8 bg-blue-600 text-white rounded-full text-sm font-bold mb-3 mx-auto">1</div>
                                    <div class="flex items-center justify-center mb-2">
                                        <i data-lucide="folder-plus" class="h-5 w-5 text-blue-600"></i>
                                    </div>
                                    <h3 class="font-medium text-gray-800 text-sm mb-1">Select Collection</h3>
                                    <p class="text-xs text-gray-600">Choose a document collection from the sidebar</p>
                                </div>

                                <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-4 border border-green-100">
                                    <div class="flex items-center justify-center w-8 h-8 bg-green-600 text-white rounded-full text-sm font-bold mb-3 mx-auto">2</div>
                                    <div class="flex items-center justify-center mb-2">
                                        <i data-lucide="message-circle-plus" class="h-5 w-5 text-green-600"></i>
                                    </div>
                                    <h3 class="font-medium text-gray-800 text-sm mb-1">Start Chat</h3>
                                    <p class="text-xs text-gray-600">Create a new chat session or continue existing one</p>
                                </div>

                                <div class="bg-gradient-to-br from-purple-50 to-violet-50 rounded-lg p-4 border border-purple-100">
                                    <div class="flex items-center justify-center w-8 h-8 bg-purple-600 text-white rounded-full text-sm font-bold mb-3 mx-auto">3</div>
                                    <div class="flex items-center justify-center mb-2">
                                        <i data-lucide="sparkles" class="h-5 w-5 text-purple-600"></i>
                                    </div>
                                    <h3 class="font-medium text-gray-800 text-sm mb-1">Ask Questions</h3>
                                    <p class="text-xs text-gray-600">Chat with your documents using natural language</p>
                                </div>
                            </div>
                        </div>

                        <!-- What You Can Do -->
                        <div class="mb-8">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">What You Can Do</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                                <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                                    <div class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <i data-lucide="search" class="h-4 w-4 text-blue-600"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-medium text-gray-800 text-sm mb-1">Smart Search</h3>
                                        <p class="text-xs text-gray-600">Find specific information across all your documents instantly</p>
                                    </div>
                                </div>

                                <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                                    <div class="flex-shrink-0 w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                                        <i data-lucide="file-text" class="h-4 w-4 text-green-600"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-medium text-gray-800 text-sm mb-1">Summarize</h3>
                                        <p class="text-xs text-gray-600">Get concise summaries of lengthy documents or sections</p>
                                    </div>
                                </div>

                                <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                                    <div class="flex-shrink-0 w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                                        <i data-lucide="list-checks" class="h-4 w-4 text-purple-600"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-medium text-gray-800 text-sm mb-1">Extract Key Points</h3>
                                        <p class="text-xs text-gray-600">Identify the most important information and insights</p>
                                    </div>
                                </div>

                                <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                                    <div class="flex-shrink-0 w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center">
                                        <i data-lucide="git-compare" class="h-4 w-4 text-orange-600"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-medium text-gray-800 text-sm mb-1">Compare & Analyze</h3>
                                        <p class="text-xs text-gray-600">Compare information across multiple documents</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sample Questions -->
                        <div class="mb-6">
                            <h2 class="text-lg font-semibold text-gray-800 mb-4">Try These Sample Questions</h2>
                            <div class="flex flex-wrap gap-2 justify-center">
                                <button class="sample-question-btn inline-flex items-center px-3 py-2 text-xs font-medium text-blue-700 bg-blue-50 hover:bg-blue-100 rounded-full border border-blue-200 transition-all hover:scale-105"
                                        onclick="chatInterface.useSampleQuestion(this)">
                                    <i data-lucide="message-square" class="h-3 w-3 mr-1"></i>
                                    "What are the main topics in my documents?"
                                </button>
                                <button class="sample-question-btn inline-flex items-center px-3 py-2 text-xs font-medium text-green-700 bg-green-50 hover:bg-green-100 rounded-full border border-green-200 transition-all hover:scale-105"
                                        onclick="chatInterface.useSampleQuestion(this)">
                                    <i data-lucide="lightbulb" class="h-3 w-3 mr-1"></i>
                                    "Give me a summary of the key findings"
                                </button>
                                <button class="sample-question-btn inline-flex items-center px-3 py-2 text-xs font-medium text-purple-700 bg-purple-50 hover:bg-purple-100 rounded-full border border-purple-200 transition-all hover:scale-105"
                                        onclick="chatInterface.useSampleQuestion(this)">
                                    <i data-lucide="help-circle" class="h-3 w-3 mr-1"></i>
                                    "What questions should I ask about this content?"
                                </button>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="text-center text-xs text-gray-500 border-t border-gray-100 pt-4">
                            <p class="flex items-center justify-center">
                                <i data-lucide="zap" class="h-3 w-3 mr-1"></i>
                                Powered by AI • Secure • Private
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Messages will be added here -->
                <div id="messages-list" class="hidden space-y-4">
                    <!-- Messages will be dynamically added -->
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="bg-white border-t p-4">
            <div class="max-w-4xl mx-auto">
                <div id="chat-input-container" class="hidden">
                    <!-- Quick Actions - moved to top -->
                    <div class="mb-3 flex flex-wrap gap-2">
                        <button class="quick-action-btn inline-flex items-center px-3 py-2 text-xs font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-full transition-colors"
                                data-action="summarize">
                            <i data-lucide="file-text" class="h-3 w-3 mr-1"></i>
                            Summarize documents
                        </button>
                        <button class="quick-action-btn inline-flex items-center px-3 py-2 text-xs font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-full transition-colors"
                                data-action="key-points">
                            <i data-lucide="list" class="h-3 w-3 mr-1"></i>
                            Key points
                        </button>
                        <button class="quick-action-btn inline-flex items-center px-3 py-2 text-xs font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-full transition-colors"
                                data-action="questions">
                            <i data-lucide="help-circle" class="h-3 w-3 mr-1"></i>
                            Suggest questions
                        </button>
                    </div>

                    <!-- Input and Send Button -->
                    <div class="flex items-end space-x-3">
                        <div class="flex-1">
                            <label for="message-input" class="sr-only">Message input</label>
                            <textarea id="message-input"
                                      placeholder="Ask a question about your documents..."
                                      class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                                      rows="1"></textarea>
                        </div>
                        <div class="flex items-end">
                            <button id="send-btn"
                                    class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
                                <i data-lucide="send" class="h-4 w-4"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="no-collection-message" class="text-center py-4 text-gray-500">
                    <p class="text-sm">Select a collection to start chatting</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Chat Session Modal -->
<div id="new-chat-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">New Chat Session</h3>
                <button id="close-chat-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="h-5 w-5"></i>
                </button>
            </div>

            <form id="new-chat-form" class="space-y-4">
                <div>
                    <label for="chat-name" class="block text-sm font-medium text-gray-700">Session Name</label>
                    <input type="text" id="chat-name" name="name" required
                           class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm px-3 py-2 border"
                           placeholder="e.g., Document Analysis">
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancel-chat-btn"
                            class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit"
                            class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                        Create Session
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .quick-action-btn {
        @apply inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500;
    }
    .message-user {
        @apply bg-blue-600 text-white ml-auto max-w-xs lg:max-w-md;
    }
    .message-assistant {
        @apply bg-white text-gray-900 mr-auto max-w-xs lg:max-w-2xl border shadow-sm;
    }
    .message-bubble {
        @apply px-4 py-2 rounded-lg break-words;
    }
    .message-bubble pre {
        @apply bg-gray-100 rounded p-2 text-sm overflow-x-auto my-2;
    }
    .message-bubble code {
        @apply bg-gray-100 px-1 py-0.5 rounded text-sm;
    }
    .message-bubble pre code {
        @apply bg-transparent px-0 py-0;
    }
    .message-bubble h1, .message-bubble h2, .message-bubble h3 {
        @apply font-bold mt-3 mb-2;
    }
    .message-bubble h1 { @apply text-lg; }
    .message-bubble h2 { @apply text-base; }
    .message-bubble h3 { @apply text-sm; }
    .message-bubble ul, .message-bubble ol {
        @apply ml-4 my-2;
    }
    .message-bubble ul { @apply list-disc; }
    .message-bubble ol { @apply list-decimal; }
    .message-bubble blockquote {
        @apply border-l-4 border-gray-300 pl-4 italic my-2;
    }
    .typing-indicator {
        @apply flex items-center space-x-1 text-gray-500 text-sm;
    }
    .typing-dot {
        @apply w-2 h-2 bg-gray-400 rounded-full animate-pulse;
        animation-delay: 0s;
    }
    .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
    }
    .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
    }
    #message-input {
        max-height: 120px;
    }
    .streaming-message {
        opacity: 0.9;
    }
    .message-sources {
        @apply text-xs text-gray-500 mt-2 pt-2 border-t border-gray-200;
    }

    .thinking-section details {
        border: 1px solid #e5e7eb;
    }

    .thinking-section summary {
        transition: color 0.2s ease;
    }

    .thinking-section summary::-webkit-details-marker {
        color: #9ca3af;
    }

    .thinking-section[open] summary {
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e5e7eb;
    }

    .main-content {
        line-height: 1.6;
    }

    .chat-session-item {
        @apply group;
    }

    .chat-session-item:hover .delete-session-btn {
        @apply opacity-100;
    }

    .delete-session-btn {
        @apply transition-opacity duration-200;
    }

    /* Add animation for messages */
    .message-enter {
        animation: messageSlideIn 0.3s ease-out;
    }

    @keyframes messageSlideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    .animate-pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    .sample-question-btn {
        transition: all 0.2s ease-in-out;
    }

    .sample-question-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .sample-question-btn:active {
        transform: translateY(0);
    }

    /* Custom gradient backgrounds */
    .bg-gradient-to-br {
        background-image: linear-gradient(to bottom right, var(--tw-gradient-stops));
    }

    .quick-action-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .delete-session-btn {
        transition: all 0.2s ease-in-out;
    }

    .chat-session-item:hover .delete-session-btn {
        opacity: 1;
    }

    /* Ensure proper alignment for send button */
    #send-btn {
        height: 48px; /* Match textarea height */
        width: 48px;
        min-width: 48px;
    }

    /* Ensure textarea and button are properly aligned */
    .flex.items-end > div {
        display: flex;
        align-items: flex-end;
    }

    .custom-scrollbar {
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 #f1f5f9;
    }

    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f5f9;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    class ChatInterface {
        constructor() {
            this.collections = [];
            this.chatSessions = [];
            this.currentCollection = null;
            this.currentSession = null;
            this.isConnected = false;
            this.websocket = null;
            this.init();
        }

        init() {
            this.bindEvents();
            this.loadCollections();
            this.loadChatSessions();
            this.autoResizeTextarea();
            this.checkUrlParams();
        }

        checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const collectionId = urlParams.get('collection_id');
            if (collectionId) {
                // Wait for collections to load, then select the collection
                setTimeout(() => {
                    this.selectCollection(collectionId);
                }, 500);
            }
        }

        bindEvents() {
            // Collection selector
            document.getElementById('collection-selector').addEventListener('change', (e) => {
                this.selectCollection(e.target.value);
            });

            // New chat button
            document.getElementById('new-chat-btn').addEventListener('click', () => this.showNewChatModal());
            document.getElementById('close-chat-modal-btn').addEventListener('click', () => this.hideNewChatModal());
            document.getElementById('cancel-chat-btn').addEventListener('click', () => this.hideNewChatModal());

            // New chat form
            document.getElementById('new-chat-form').addEventListener('submit', (e) => this.createChatSession(e));

            // Message input
            const messageInput = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');

            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendMessage();
                }
            });

            sendBtn.addEventListener('click', () => this.sendMessage());

            // Quick actions
            document.querySelectorAll('.quick-action-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const action = e.currentTarget.dataset.action;
                    this.handleQuickAction(action);
                });
            });
        }

        useSampleQuestion(button) {
            const questionText = button.textContent.replace(/"/g, '').trim();
            const messageInput = document.getElementById('message-input');
            if (messageInput) {
                messageInput.value = questionText;
                messageInput.focus();
                // Optionally auto-send the question
                // this.sendMessage();
            }
        }

        async loadCollections() {
            try {
                this.collections = await utils.apiRequest('/collections/');
                this.renderCollectionSelector();
            } catch (error) {
                console.error('Failed to load collections:', error);
                utils.showToast('Failed to load collections', 'error');
            }
        }

        renderCollectionSelector() {
            const selector = document.getElementById('collection-selector');
            selector.innerHTML = '<option value="">Select Collection...</option>' +
                this.collections.map(collection =>
                    `<option value="${collection.id}">${collection.name}</option>`
                ).join('');
        }

        async selectCollection(collectionId) {
            if (!collectionId) {
                this.currentCollection = null;
                this.currentSession = null;
                this.showWelcomeMessage();
                return;
            }

            this.currentCollection = this.collections.find(c => c.id === collectionId);
            if (!this.currentCollection) return;

            // Update UI
            document.getElementById('collection-selector').value = collectionId;
            document.getElementById('current-collection-name').textContent = this.currentCollection.name;
            document.getElementById('current-collection-color').style.backgroundColor = this.currentCollection.color;
            document.getElementById('collection-info').classList.remove('hidden');

            // Update chat title
            document.getElementById('chat-title').textContent = this.currentCollection.name;
            document.getElementById('chat-subtitle').classList.remove('hidden');

            // Show chat input
            document.getElementById('chat-input-container').classList.remove('hidden');
            document.getElementById('no-collection-message').classList.add('hidden');

            // Load chat sessions for this collection
            await this.loadChatSessions();

            // Hide welcome message
            document.getElementById('welcome-message').classList.add('hidden');
        }

        async loadChatSessions() {
            try {
                document.getElementById('chat-sessions-loading').classList.remove('hidden');
                document.getElementById('chat-sessions-empty').classList.add('hidden');
                document.getElementById('chat-sessions-list').classList.add('hidden');

                // Load all chat sessions from API
                const allSessions = await utils.apiRequest('/chat/sessions');

                // Filter sessions for current collection
                if (this.currentCollection) {
                    this.chatSessions = allSessions.filter((session) =>
                        session.collection_id === this.currentCollection.id
                    );
                }

                this.renderChatSessions();

                // If we have sessions, select the most recent one
                if (this.chatSessions.length > 0 && !this.currentSession) {
                    // Sort by updated_at or created_at, most recent first
                    const sortedSessions = [...this.chatSessions].sort((a, b) =>
                        new Date(b.updated_at) - new Date(a.updated_at)
                    );
                    await this.selectSession(sortedSessions[0].id);
                }
            } catch (error) {
                console.error('Failed to load chat sessions:', error);
                document.getElementById('chat-sessions-loading').classList.add('hidden');
                document.getElementById('chat-sessions-empty').classList.remove('hidden');
            }
        }

        async createDefaultSession() {
            try {
                const session = await utils.apiRequest('/chat/sessions', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: `Chat with ${this.currentCollection.name}`,
                        collection_id: this.currentCollection.id
                    })
                });

                this.currentSession = session;
                this.chatSessions = [session];
                this.renderChatSessions();

            } catch (error) {
                console.error('Failed to create default session:', error);
            }
        }

        renderChatSessions() {
            const loading = document.getElementById('chat-sessions-loading');
            const empty = document.getElementById('chat-sessions-empty');
            const list = document.getElementById('chat-sessions-list');

            loading.classList.add('hidden');

            if (this.chatSessions.length === 0) {
                empty.classList.remove('hidden');
                list.classList.add('hidden');
            } else {
                empty.classList.add('hidden');
                list.classList.remove('hidden');

                // Sort sessions by updated_at, most recent first
                const sortedSessions = [...this.chatSessions].sort((a, b) =>
                    new Date(b.updated_at) - new Date(a.updated_at)
                );

                list.innerHTML = sortedSessions.map(session => `
                    <div class="chat-session-item group p-3 hover:bg-gray-50 cursor-pointer border-l-4 transition-colors ${session.id === this.currentSession?.id ? 'border-blue-500 bg-blue-50' : 'border-transparent'}"
                         onclick="chatInterface.selectSession('${session.id}')">
                        <div class="flex items-center justify-between">
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900 truncate" title="${session.name}">${session.name}</p>
                                <div class="flex items-center justify-between mt-1">
                                    <p class="text-xs text-gray-500">${utils.formatDate(session.updated_at)}</p>
                                    ${session.message_count > 0 ? `<span class="text-xs text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full">${session.message_count}</span>` : ''}
                                </div>
                            </div>
                            <div class="ml-2 flex flex-col items-center">
                                <i data-lucide="message-circle" class="h-4 w-4 text-gray-400"></i>
                                <button class="delete-session-btn mt-1 p-1 text-gray-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100"
                                        onclick="chatInterface.handleDeleteSession(arguments[0], '${session.id}')"
                                        title="Delete session">
                                    <i data-lucide="trash-2" class="h-3 w-3"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');

                lucide.createIcons();
            }
        }

        async selectSession(sessionId) {
            const session = this.chatSessions.find(s => s.id === sessionId);
            if (!session) return;

            this.currentSession = session;
            this.renderChatSessions();

            // Update chat title to show session name
            document.getElementById('chat-title').textContent = session.name;

            // Load messages for this session
            await this.loadMessages(sessionId);
        }

        handleDeleteSession(event, sessionId) {
            event.stopPropagation();
            this.deleteSession(sessionId);
        }
        async deleteSession(sessionId) {
            if (!confirm('Are you sure you want to delete this chat session?')) {
                return;
            }

            try {
                await utils.apiRequest(`/chat/sessions/${sessionId}`, {
                    method: 'DELETE'
                });

                // Remove from local array
                this.chatSessions = this.chatSessions.filter(s => s.id !== sessionId);

                // If this was the current session, clear it
                if (this.currentSession?.id === sessionId) {
                    this.currentSession = null;
                    this.clearMessages();

                    // Select another session if available
                    if (this.chatSessions.length > 0) {
                        const sortedSessions = [...this.chatSessions].sort((a, b) =>
                            new Date(b.updated_at) - new Date(a.updated_at)
                        );
                        await this.selectSession(sortedSessions[0].id);
                    } else {
                        // Update title to collection name
                        document.getElementById('chat-title').textContent = this.currentCollection.name;
                    }
                }

                this.renderChatSessions();
                utils.showToast('Chat session deleted', 'success');
            } catch (error) {
                console.error('Failed to delete session:', error);
                utils.showToast('Failed to delete session', 'error');
            }
        }

        showNewChatModal() {
            if (!this.currentCollection) {
                utils.showToast('Please select a collection first', 'warning');
                return;
            }
            document.getElementById('new-chat-modal').classList.remove('hidden');
        }

        hideNewChatModal() {
            document.getElementById('new-chat-modal').classList.add('hidden');
            document.getElementById('new-chat-form').reset();
        }

        async createChatSession(e) {
            e.preventDefault();
            if (!this.currentCollection) return;

            const formData = new FormData(e.target);
            const data = {
                name: formData.get('name'),
                collection_id: this.currentCollection.id
            };

            try {
                const session = await utils.apiRequest('/chat/sessions', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                // Add to local array and sort
                this.chatSessions.unshift(session);
                this.currentSession = session;

                this.renderChatSessions();
                this.hideNewChatModal();
                this.clearMessages();

                // Update title
                document.getElementById('chat-title').textContent = session.name;

                utils.showToast('Chat session created!', 'success');
            } catch (error) {
                console.error('Failed to create chat session:', error);
                utils.showToast('Failed to create chat session', 'error');
            }
        }

        async sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            if (!message || !this.currentSession) return;

            // Disable send button and input
            const sendBtn = document.getElementById('send-btn');
            sendBtn.disabled = true;
            input.disabled = true;

            // Add user message to UI
            this.addMessage('user', message);
            input.value = '';
            this.resizeTextarea();

            // Show typing indicator and prepare assistant message
            const assistantMessageId = this.showStreamingMessage();

            try {
                // Send streaming request
                const response = await fetch('/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: this.currentSession.id,
                        user_message: message
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';
                let retrievedChunks = [];

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                let dataStr = line.slice(6).trim();
                                if (dataStr) {
                                    let data;

                                    try {
                                        // First try to parse as valid JSON
                                        data = JSON.parse(dataStr);
                                    } catch (jsonError) {
                                        // Handle Python dict format with proper escaping
                                        try {
                                            // More sophisticated quote handling
                                            let processedStr = dataStr;

                                            // Handle the case where the response contains apostrophes like 's, 't, 'll
                                            processedStr = processedStr.replace(/{'response': '([^'}]*)'}/g, (match, content) => {
                                                // Escape any double quotes in the content
                                                const escapedContent = content.replace(/"/g, '\\"');
                                                return `{"response": "${escapedContent}"}`;
                                            });

                                            // Handle retrieved_chunks array
                                            processedStr = processedStr.replace(/'retrieved_chunks': \[([^\]]*)\]/g, (match, content) => {
                                                const cleanContent = content.replace(/'/g, '"');
                                                return `"retrieved_chunks": [${cleanContent}]`;
                                            });

                                            data = JSON.parse(processedStr);
                                        } catch (secondError) {
                                            console.warn('Failed to parse streaming data:', line, 'Error:', secondError.message);
                                            continue;
                                        }
                                    }

                                    // Handle retrieved chunks info
                                    if (data.retrieved_chunks) {
                                        retrievedChunks = data.retrieved_chunks;
                                    }

                                    // Handle response streaming
                                    if (data.hasOwnProperty('response')) {
                                        fullResponse += data.response;
                                        this.updateStreamingMessage(assistantMessageId, fullResponse, retrievedChunks);
                                    }
                                }
                            } catch (e) {
                                console.warn('Failed to parse streaming data:', line, 'Error:', e.message);
                            }
                        }
                    }
                }

                // Finalize the message
                this.finalizeStreamingMessage(assistantMessageId, fullResponse, retrievedChunks);

            } catch (error) {
                console.error('Failed to send message:', error);
                this.updateStreamingMessage(assistantMessageId, 'Sorry, I encountered an error while processing your request.', []);
                this.finalizeStreamingMessage(assistantMessageId, 'Sorry, I encountered an error while processing your request.', []);
            } finally {
                // Re-enable send button and input
                sendBtn.disabled = false;
                input.disabled = false;
                input.focus();
            }
        }

        addMessage(sender, content, retrievedChunks = []) {
            const messagesList = document.getElementById('messages-list');
            const messagesContainer = document.getElementById('messages-container');

            // Show messages list if hidden
            if (messagesList.classList.contains('hidden')) {
                messagesList.classList.remove('hidden');
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} message-enter`;

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `message-bubble message-${sender}`;

            if (sender === 'user') {
                bubbleDiv.textContent = content;
            } else {
                // Parse thinking sections and main content for assistant messages
                const { thinkingContent, mainContent } = this.parseThinkingContent(content);

                let html = '';
                // Add thinking section if present
                if (thinkingContent.trim()) {
                    html += `
                        <div class="thinking-section mb-3">
                            <details class="text-xs text-gray-500 bg-gray-50 rounded p-2">
                                <summary class="cursor-pointer hover:text-gray-700 font-medium">
                                    <i data-lucide="brain" class="h-3 w-3 inline mr-1"></i>
                                    Thinking process...
                                </summary>
                                <div class="mt-2 pl-4 border-l-2 border-gray-200 whitespace-pre-wrap">${this.escapeHtml(thinkingContent.trim())}</div>
                            </details>
                        </div>
                    `;
                }

                // Add main content
                const contentToRender = mainContent.trim() || content;
                html += `<div class="main-content">${marked.parse(contentToRender)}</div>`;

                bubbleDiv.innerHTML = html;

                // Highlight code blocks
                bubbleDiv.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });

                // Add sources if available
                if (retrievedChunks && retrievedChunks.length > 0) {
                    const sourcesDiv = document.createElement('div');
                    sourcesDiv.className = 'message-sources';
                    sourcesDiv.innerHTML = `
                        <div class="flex items-center">
                            <i data-lucide="file-text" class="h-3 w-3 mr-1"></i>
                            <span>Sources: ${retrievedChunks.length} document chunk${retrievedChunks.length > 1 ? 's' : ''}</span>
                        </div>
                    `;
                    bubbleDiv.appendChild(sourcesDiv);
                }

                // Recreate icons
                lucide.createIcons();
            }

            messageDiv.appendChild(bubbleDiv);
            messagesList.appendChild(messageDiv);

            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return messageDiv;
        }

        showStreamingMessage() {
            const messagesList = document.getElementById('messages-list');

            // Show messages list if hidden
            if (messagesList.classList.contains('hidden')) {
                messagesList.classList.remove('hidden');
            }

            const messageId = 'streaming-' + Date.now();
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.className = 'flex justify-start message-enter';

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble message-assistant streaming-message';
            bubbleDiv.innerHTML = `
                <div class="typing-indicator">
                    <div class="flex space-x-1">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;

            messageDiv.appendChild(bubbleDiv);
            messagesList.appendChild(messageDiv);

            // Scroll to bottom
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            return messageId;
        }

        updateStreamingMessage(messageId, content, retrievedChunks = []) {
            const messageElement = document.getElementById(messageId);
            if (!messageElement) return;

            const bubbleDiv = messageElement.querySelector('.message-bubble');

            // Parse thinking sections and main content
            const { thinkingContent, mainContent } = this.parseThinkingContent(content);

            // If no meaningful content yet, show typing indicator
            if (!mainContent.trim() && !thinkingContent.trim()) {
                bubbleDiv.innerHTML = `
                    <div class="typing-indicator">
                        <div class="flex space-x-1">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                `;
            } else {
                let html = '';

                // Add thinking section if present
                if (thinkingContent.trim()) {
                    html += `
                        <div class="thinking-section mb-3">
                            <details class="text-xs text-gray-500 bg-gray-50 rounded p-2">
                                <summary class="cursor-pointer hover:text-gray-700 font-medium">
                                    <i data-lucide="brain" class="h-3 w-3 inline mr-1"></i>
                                    Thinking process...
                                </summary>
                                <div class="mt-2 pl-4 border-l-2 border-gray-200 whitespace-pre-wrap">${this.escapeHtml(thinkingContent.trim())}</div>
                            </details>
                        </div>
                    `;
                }

                // Add main content if present
                if (mainContent.trim()) {
                    html += `<div class="main-content">${marked.parse(mainContent.trim())}</div>`;
                }

                bubbleDiv.innerHTML = html;

                // Highlight code blocks
                bubbleDiv.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });

                // Add sources if available
                if (retrievedChunks && retrievedChunks.length > 0) {
                    const sourcesDiv = document.createElement('div');
                    sourcesDiv.className = 'message-sources';
                    sourcesDiv.innerHTML = `
                        <div class="flex items-center">
                            <i data-lucide="file-text" class="h-3 w-3 mr-1"></i>
                            <span>Sources: ${retrievedChunks.length} document chunk${retrievedChunks.length > 1 ? 's' : ''}</span>
                        </div>
                    `;
                    bubbleDiv.appendChild(sourcesDiv);
                }

                // Recreate icons
                lucide.createIcons();
            }

            // Scroll to bottom
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        parseThinkingContent(content) {
            let thinkingContent = '';
            let mainContent = content;

            // Extract thinking sections
            const thinkingRegex = /<think>(.*?)<\/think>/gs;
            const matches = content.match(thinkingRegex);

            if (matches) {
                // Combine all thinking sections
                thinkingContent = matches.map(match =>
                    match.replace(/<\/?think>/g, '').trim()
                ).join('\n\n');

                // Remove thinking sections from main content
                mainContent = content.replace(thinkingRegex, '').trim();
            }

            return { thinkingContent, mainContent };
        }

        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        finalizeStreamingMessage(messageId, content, retrievedChunks = []) {
            const messageElement = document.getElementById(messageId);
            if (!messageElement) return;

            // Remove streaming class
            const bubbleDiv = messageElement.querySelector('.message-bubble');
            bubbleDiv.classList.remove('streaming-message');

            // Final update with complete content
            this.updateStreamingMessage(messageId, content, retrievedChunks);

            // If no actual content was received, show error message
            const { thinkingContent, mainContent } = this.parseThinkingContent(content);
            if (!mainContent.trim() && !thinkingContent.trim()) {
                bubbleDiv.innerHTML = '<div class="text-gray-500 italic">No response received</div>';
            }

            // Remove the temporary ID
            messageElement.removeAttribute('id');
        }

        async loadMessages(sessionId) {
            try {
                this.clearMessages();

                // Show loading state
                const messagesContainer = document.getElementById('messages-container');
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'messages-loading';
                loadingDiv.className = 'text-center py-8';
                loadingDiv.innerHTML = `
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto"></div>
                    <p class="text-sm text-gray-500 mt-2">Loading messages...</p>
                `;
                messagesContainer.appendChild(loadingDiv);

                // Load messages from API
                const messages = await utils.apiRequest(`/chat/messages?session_id=${sessionId}`);

                // Remove loading state
                const loading = document.getElementById('messages-loading');
                if (loading) loading.remove();

                if (messages.length === 0) {
                    // Show empty state for this session
                    // const emptyDiv = document.createElement('div');
                    // emptyDiv.className = 'text-center py-8';
                    const messagesList = document.getElementById('messages-list');
                    messagesList.classList.remove('hidden');
                    messagesList.innerHTML = `
                        <div class="bg-white rounded-lg shadow-sm p-6 max-w-md mx-auto">
                            <i data-lucide="message-circle" class="h-8 w-8 text-gray-400 mx-auto mb-3"></i>
                            <p class="text-gray-600 text-sm">Start a conversation with your documents</p>
                        </div>
                    `;
                    // messagesContainer.appendChild(emptyDiv);
                } else {
                    // Show messages list
                    const messagesList = document.getElementById('messages-list');
                    messagesList.classList.remove('hidden');

                    // Add messages to UI
                    messages.forEach(message => {
                        this.addMessage('user', message.user_message);
                        this.addMessage('assistant', message.assistant_response, message.retrieved_chunks);
                    });
                }
            } catch (error) {
                console.error('Failed to load messages:', error);
                const loading = document.getElementById('messages-loading');
                if (loading) loading.remove();
                utils.showToast('Failed to load chat history', 'error');
            }
        }

        clearMessages() {
            const messagesList = document.getElementById('messages-list');
            messagesList.innerHTML = '';
            messagesList.classList.add('hidden');
        }

        showWelcomeMessage() {
            document.getElementById('welcome-message').classList.remove('hidden');
            document.getElementById('chat-input-container').classList.add('hidden');
            document.getElementById('no-collection-message').classList.remove('hidden');
            document.getElementById('chat-title').textContent = 'Select a collection to start chatting';
            document.getElementById('chat-subtitle').classList.add('hidden');
            this.clearMessages();
        }

        handleQuickAction(action) {
            const messageInput = document.getElementById('message-input');

            const actions = {
                summarize: 'Please provide a summary of all the documents in this collection.',
                'key-points': 'What are the key points from the documents in this collection?',
                questions: 'What are some interesting questions I could ask about these documents?'
            };

            if (actions[action]) {
                messageInput.value = actions[action];
                messageInput.focus();
                this.resizeTextarea();
            }
        }

        autoResizeTextarea() {
            const textarea = document.getElementById('message-input');
            textarea.addEventListener('input', () => this.resizeTextarea());
        }

        resizeTextarea() {
            const textarea = document.getElementById('message-input');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }
    }

    // Initialize chat interface
    const chatInterface = new ChatInterface();
</script>
{% endblock %}